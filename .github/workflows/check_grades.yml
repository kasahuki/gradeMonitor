name: Check Grades

on:
  schedule:
    - cron: '0 * * * *'  # 每小时整点运行（UTC时间）
  workflow_dispatch:  # 支持手动触发

jobs:
  check:
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium
      
      - name: Download grades cache
        uses: dawidd6/action-download-artifact@v3
        with:
          name: grades-cache
          path: .
          if_no_artifact_found: ignore
      
      - name: Run grade checker
        env:
          JW_USERNAME: ${{ secrets.JW_USERNAME }}
          JW_PASSWORD: ${{ secrets.JW_PASSWORD }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: python SysMonitor.py
      
      - name: Upload captcha for debug
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: captcha-debug
          path: temp_captcha.png
          retention-days: 1
          if-no-files-found: ignore
      
      - name: Upload grades cache
        uses: actions/upload-artifact@v4
        with:
          name: grades-cache
          path: grades_cache.json
          retention-days: 90
          overwrite: true
